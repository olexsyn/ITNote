# Логи в Python. Налаштування та централізація

## Вступ

Вбудований модуль Python `logging` розроблений для того, щоб дати вам детальне уявлення про програми з мінімальними налаштуваннями. Чи починаєте ви роботу або вже працюєте, у посібнику ви побачите, як налаштувати цей модуль, щоб допомогти знайти потрібний рядок коду.

У цьому пості ми покажемо вам, як:

- Налаштувати пріоритет та розташування журналів.
- Створити налаштування користувача, що включають кілька логерів і адресатів.
- Додати трасування винятків у логи.
- Відформатувати логі в JSON та централізувати їх.

## Основи

Модуль `logging` включений до стандартної бібліотеки Python. Метод `basicConfig()`  —  найшвидший спосіб налаштування. Проте в документації рекомендується створювати логер для кожного модуля програми, а значить, може бути складно конфігурувати логер для кожного модуля, використовуючи лише `basicConfig()`. Тому більшість програм (включаючи веб-фреймворки, наприклад Django) автоматично ведуть журнали на основі файлів або словника. Якщо ви хочете почати з одного з цих методів, ми рекомендуємо перейти до потрібного розділу.

У `basicConfig()` три основні параметри:

- **level**: мінімальний рівень логування. Доступні рівні: `DEBUG`, `INFO`, `WARNING`, `ERROR` та `CRITICAL`. Рівень за замовчуванням  —  `WARNING`, тобто відфільтровуються повідомлення рівнів `DEBUG` та `INFO`.
- **handler**: визначає, куди надіслати логи. Якщо не вказано інше, `StreamHandler` використовується для надсилання повідомлень до `sys.stderr`.
- **format**: формат, за замовчуванням він такий: `<РІВЕНЬ>: <ІМ'Я_ЛОГГЕРА>: <ПОВІДОМЛЕННЯ>`.

У наступному розділі ми покажемо, як налаштувати його, щоб увімкнути позначки часу та іншу корисну інформацію.

Оскільки за промовчанням пишуться лише журнали `WARNING` та вищого рівня, вам може не вистачати логів із низьким пріоритетом. Крім того, замість `StreamHandler` або `SocketHandler` для потокової передачі безпосередньо на консоль або у зовнішню службу через мережу, вам краще використовувати `FileHandler`, щоб писати в один або кілька файлів на диску.

Якщо при передачі через мережу виникнуть проблеми, то у вас не буде вільного доступу до цих логів: вони зберігатимуться на кожному сервері локально. Логування у файл дозволяє створювати різні типи логів та об'єднувати їх службою моніторингу.

## Базовий приклад

У наступному прикладі використовується `basicConfig()`, щоб налаштувати програму для логування `DEBUG` і вище на диск, і вказується на наявність дати, часу та серйозності у рядку лога:

```python
import logging

def word_count(myfile):
    logging.basicConfig(level=logging.DEBUG, filename='myapp.log', format='%(asctime)s %(levelname)s:%(message)s')
    try:
        # считаем слова, логируем результат.
        with open(myfile, 'r') as f:
            file_data = f.read()
            words = file_data.split(" ")
            num_words = len(words)
            logging.debug("this file has %d words", num_words)
            return num_words
    except OSError as e:
        logging.error("error reading the file")
```

Якщо на вході буде недоступний файл, в лог запишеться:

```
2019-03-27 10:49:00,979 DEBUG:this file has 44 words
2019-03-27 10:49:00,979 ERROR:error reading the file
```

Завдяки новій конфігурації повідомлення `DEBUG` не фільтруються і, крім повідомлення про помилку, дають інформацію про дату, місцевий час та рівень важливості:

- **%(asctime)s**: дата та місцевий час.
- **%(levelname)s**: рівень.
- **%(message)s**: повідомлення.

[Тут інформація про стандартні атрибути](https://docs.python.org/3/library/logging.html#logrecord-attributes). У прикладі вище логування не включає трасування, ускладнюючи визначення джерела проблеми. Нижче ми покажемо логування трасування винятків.

## Деталі

Що робити, коли програма розростається? Вам потрібна надійна, масштабована конфігурація та ім'я логера як частина кожного лога. У цій частині ми:

- Налаштуємо множинний логування з відображенням [імені лога](https://docs.python.org/3.7/library/logging.html#logging.getLogger).
- Використовуємо `fileConfig`, щоб реалізувати логування користувача і роутинг.
- Запишемо в лог трасування та необроблені винятки.

## Конфігурування

Наслідуючи кращі практики, використовуємо метод отримання імені лога модуля:
